# issue ym2151-log-play-server の新たな仕様に基づいて、serverを起動できるようにする #8
[issues #8](https://github.com/cat2151/cat-edit-mml/issues/8)

## 参考
https://github.com/cat2151/ym2151-log-play-server/pull/39

## 実装内容

### ym2151-log-play-server PR#39 の変更内容
サーバー起動時の仕様が以下のように変更されました：
- **変更前**: `ym2151-log-play-server --server output_ym2151.json` (起動時にJSONファイル必須)
- **変更後**: `ym2151-log-play-server --server` (待機状態で起動、JSONはクライアントから送信)

### cat-edit-mml の実装変更

#### 1. 起動時のサーバーチェック
- `App::new()`で`MmlProcessor::ensure_server_running()`を呼び出し
- サーバーが起動していない場合、`cat-play-mml --server`を起動
- デタッチモードで起動し、バックグラウンドで動作

#### 2. サーバー起動待機のベストプラクティス
- **ポーリング方式**: 100msごとにサーバー起動を確認
- **早期完了**: サーバーが起動次第すぐに処理を続行
- **タイムアウト**: 最大5秒まで待機（50回のポーリング）
- **ユーザー体験**: 起動時間をフィードバック表示
- ハードコーディングされた固定待機時間を排除

#### 3. 演奏機能の実装
- MML → SMF → YM2151 JSON 変換を実装
- `client::send_json()`を使用（サイズに応じて自動的に最適な方法を選択）
  - 4KB未満: 直接送信
  - 4KB以上: 一時ファイル経由で送信（ライブラリが自動処理）
- レスポンス改善のため、JSONを直接送信

#### 4. プラットフォーム対応
- Windows: 完全機能（サーバー起動、直接演奏）
- Linux/その他: エディタは動作、演奏は警告メッセージ

### API変更対応
- ym2151-log-play-serverのAPI変更に対応
  - 旧API: `send_json_direct()` / `send_json_via_file()` (手動でサイズチェック)
  - 新API: `send_json()` (自動的に最適な送信方法を選択)

### 依存関係の追加
- `mmlabc-to-smf`: MMLからSMFへの変換
- `smf-to-ym2151log-rust`: SMFからYM2151ログへの変換
- `ym2151-log-play-server`: サーバーとの通信
- `serde_json`: JSON処理

### 検証結果
- ✅ ビルド成功（debug/release）
- ✅ テスト成功 (9/9 テスト合格)
- ✅ 依存関係の確認完了
- ✅ プラットフォーム固有の機能を適切に分離
- ✅ API変更に対応完了
- ✅ サーバー起動待機ロジック改善完了

### コミット履歴
- d7f0f2a: サーバー起動と直接JSON再生の実装
- a176db4: issue notesの更新
- 52e8a21: 新しいsend_json() APIに対応
- （最新）: ポーリング方式でのサーバー起動待機実装

